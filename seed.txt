WITH line AS (SELECT id FROM qc.production_lines WHERE code='3'),
    ins AS (
      INSERT INTO qc.items
        (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
        item_status_id,ai_note)
      SELECT
        'ROLL', line.id, '13W10C2MB','250814002D05','3D3G256046',193, now()-interval '30 min',
        (SELECT id FROM qc.item_statuses WHERE code='DEFECT'),
        'Defect: ด้านล่าง'
      FROM line RETURNING id
    )
INSERT INTO qc.item_defects(item_id, defect_type_id, meta)
SELECT ins.id,(SELECT id FROM qc.defect_types WHERE code='BOTTOM'),
        '{"source":"AI"}'::jsonb
FROM ins;

-- ROLL: DEFECT (TOP)
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3'),
      ins AS (
        INSERT INTO qc.items
          (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
          item_status_id,ai_note)
        SELECT
          'ROLL', line.id, '13W10C2MB','250814002D06','3D3G256047',190, now()-interval '1 hour',
          (SELECT id FROM qc.item_statuses WHERE code='DEFECT'),
          'Defect: ด้านบน'
        FROM line RETURNING id
      )
INSERT INTO qc.item_defects(item_id, defect_type_id, meta)
SELECT ins.id,(SELECT id FROM qc.defect_types WHERE code='TOP'),
        '{"source":"AI"}'::jsonb
FROM ins;

-- ROLL: DEFECT (BARCODE)
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3'),
      ins AS (
        INSERT INTO qc.items
          (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
          item_status_id,ai_note)
        SELECT
          'ROLL', line.id, '13W10C2MB','250814002D07','3D3G256048',185, now()-interval '2 hour',
          (SELECT id FROM qc.item_statuses WHERE code='DEFECT'),
          'Defect: บาร์โค้ด'
        FROM line RETURNING id
      )
INSERT INTO qc.item_defects(item_id, defect_type_id, meta)
SELECT ins.id,(SELECT id FROM qc.defect_types WHERE code='BARCODE'),
        '{"source":"AI"}'::jsonb
FROM ins;

-- ROLL: SCRAP (AI ตรงๆ) + operator confirm
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3'),
ins AS (
  INSERT INTO qc.items
    (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
      item_status_id,ai_note,acknowledged_by,acknowledged_at)
  SELECT 'ROLL', 2, '13W10C2MB','250723017E16','3D3G256045',270, now()-interval '3 hour',
          (SELECT id FROM qc.item_statuses WHERE code='SCRAP'),
          'Scrap (ไม่พบฉลาก)',
          (SELECT id FROM "user".users WHERE username='op_3a'), now()
  FROM line RETURNING id
)
INSERT INTO qc.item_events(item_id,actor_id,event_type,to_status_id,details)
SELECT id,(SELECT id FROM "user".users WHERE username='op_3a'),
      'OPERATOR_CONFIRM_SCRAP',(SELECT id FROM qc.item_statuses WHERE code='SCRAP'),
      '{"note":"AI scrap confirmed"}'::jsonb
FROM ins;

-- ROLL: SCRAP (ยังไม่ confirm)
WITH line AS (SELECT id FROM qc.production_lines WHERE code='4')
INSERT INTO qc.items
  (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
    item_status_id,ai_note)
SELECT 'ROLL', line.id, '13W10C2MB','250723017E17','3D3G256049',275, now()-interval '4 hour',
        (SELECT id FROM qc.item_statuses WHERE code='SCRAP'),
        'Scrap (AI detected)' FROM line;

-- BUNDLE: DEFECT (LABEL)
WITH line AS (SELECT id FROM qc.production_lines WHERE code='4'),
      ins AS (
        INSERT INTO qc.items
          (station,line_id,bundle_number,detected_at,
          item_status_id,ai_note)
        SELECT
          'BUNDLE', line.id,'250723017E16', now()-interval '2 hour',
          (SELECT id FROM qc.item_statuses WHERE code='DEFECT'),
          'Defect: ฉลาก'
        FROM line
        RETURNING id
      )
INSERT INTO qc.item_defects(item_id, defect_type_id, meta)
SELECT ins.id,(SELECT id FROM qc.defect_types WHERE code='LABEL'),
        '{"note":"missing label"}'::jsonb
FROM ins;

-- BUNDLE: DEFECT (BARCODE)
WITH line AS (SELECT id FROM qc.production_lines WHERE code='4'),
      ins AS (
        INSERT INTO qc.items
          (station,line_id,bundle_number,detected_at,
          item_status_id,ai_note)
        SELECT
          'BUNDLE', line.id,'250723017E17', now()-interval '3 hour',
          (SELECT id FROM qc.item_statuses WHERE code='DEFECT'),
          'Defect: บาร์โค้ด'
        FROM line
        RETURNING id
      )
INSERT INTO qc.item_defects(item_id, defect_type_id, meta)
SELECT ins.id,(SELECT id FROM qc.defect_types WHERE code='BARCODE'),
        '{"note":"barcode unreadable"}'::jsonb
FROM ins;

-- ROLL: NORMAL
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3')
INSERT INTO qc.items
  (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
    item_status_id,ai_note)
SELECT 'ROLL', line.id, '13W10C2MB','462266','3D3G256050',200, now()-interval '5 hour',
        (SELECT id FROM qc.item_statuses WHERE code='NORMAL'),
        'OK' FROM line;

-- ROLL: QC_PASSED
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3')
INSERT INTO qc.items
  (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
    item_status_id,ai_note)
SELECT 'ROLL', line.id, '13W10C2MB','462267','3D3G256051',210, now()-interval '6 hour',
        (SELECT id FROM qc.item_statuses WHERE code='QC_PASSED'),
        'QC passed after recheck' FROM line;

-- ROLL: RECHECK
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3')
INSERT INTO qc.items
  (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
    item_status_id,ai_note)
SELECT 'ROLL', line.id, '13W10C2MB','462268','3D3G256051',210, now()-interval '6 hour',
        (SELECT id FROM qc.item_statuses WHERE code='RECHECK'),
        'QC passed after recheck' FROM line;
WITH line AS (SELECT id FROM qc.production_lines WHERE code='3')
INSERT INTO qc.items
  (station,line_id,product_code,roll_number,job_order_number,roll_width,detected_at,
    item_status_id,ai_note)
SELECT 'ROLL', line.id, '13W10C2MB','462269','3D3G256051',210, now()-interval '6 hour',
        (SELECT id FROM qc.item_statuses WHERE code='RECHECK'),
        'QC passed after recheck' FROM line;

INSERT INTO qc.item_images (item_id, review_id, kind, path) VALUES
  (1, NULL, 'DETECTED', '2025-08/21/line_3/roll/250814002D05/capture/698877.jpg'),
  (2, NULL, 'DETECTED', '2025-08/21/line_3/roll/250814002D06/capture/698878.jpg'),
  (3, NULL, 'DETECTED', '2025-08/21/line_3/roll/250814002D07/capture/698879.jpg'),
  (4, NULL, 'DETECTED', '2025-08/21/line_4/roll/250723017E16/capture/331582.jpg'),
  (5, NULL, 'DETECTED', '2025-08/21/line_4/roll/250723017E17/capture/331583.jpg'),
  (6, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E16/capture/331582_barcode.jpg'),
  (6, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E16/capture/331582_bottom_1.jpg'),
  (6, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E16/capture/331582_bottom_2.jpg'),
  (6, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E16/capture/331582_bottom_3.jpg'),
  (7, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E17/capture/331583_top_1.jpg'),
  (7, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E17/capture/331583_top_2.jpg'),
  (7, NULL, 'DETECTED', '2025-08/21/line_4/bundle/250723017E17/capture/331583_top_3.jpg'),
  (8, NULL, 'DETECTED', '2025-08/21/line_4/roll/250723017E18/capture/331584.jpg'),
  (9, NULL, 'DETECTED', '2025-08/21/line_4/roll/250723017E18/capture/331584.jpg');



  docker swarm join --token SWMTKN-1-5nvqllvm2qxksl32j7a6lunqsrv4v9w9852h2oc4nq86eu62d4-a2hylgx8cvt1ubj5vux492tud 192.168.65.3:2377